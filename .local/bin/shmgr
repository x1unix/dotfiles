#!/usr/bin/env sh
set -e

SCRIPT="$(basename $0)"
SHELL_RES="${SHELL_RES:-$HOME/.config/shell}"
AUTOLOAD_FILE="${AUTOLOAD_FILE:-$SHELL_RES/.autoload.sh}"
AUTOLOAD_TEMP="$SHELL_RES/.autoload.tmp"

app_help() {
  cat <<EOF
Usage: $(basename $SCRIPT) <command> [args...]

Commands:
  ls        - List includes, functions or aliases.
  edit      - Edit include, function or alias file.
  rm        - Remove include, function or alias file.
  gen       - Generate autoload file.
EOF
}

autoload_append_dir() {
  if [ ! -d "$SHELL_RES/$1" ]; then
    return 0
  fi

  for file in "$SHELL_RES/$1"/*.sh; do
    echo "$file"
    echo "### Source: $file" >> "$AUTOLOAD_TEMP"
    cat "$file" >> "$AUTOLOAD_TEMP"
  done
}

app_gen_autoload () {
  echo ":: Generating new autoload file..."
  if [ -f "$AUTOLOAD_TEMP" ]; then
    rm -f "$AUTOLOAD_TEMP"
  fi

  touch "$AUTOLOAD_TEMP"
  printf '### This file was generated by shmgr. DO NOT EDIT!\n### Generated at: %s\n\n' "$(date)" >> "$AUTOLOAD_TEMP"
  autoload_append_dir 'include.d'
  autoload_append_dir 'func.d'
  autoload_append_dir 'alias.d'
  rm -f "$AUTOLOAD_FILE"
  mv "$AUTOLOAD_TEMP" "$AUTOLOAD_FILE"
}

assert_ne() {
  if [ -z "$1" ]; then
    echo "Error: $2"
    exit 1
  fi
}

validate_dir() {
  if [ -z "$1" ]; then
    echo "Error: missing identifier"
    exit 1
  fi
  if [ ! -d "$SHELL_RES/$1.d" ]; then
    echo "Error: $SHELL_RES/$1.d does not exists"
    exit 1
  fi
}

app_ls() {
  validate_dir "$1"
  ls -l "$SHELL_RES/$1.d"/*.sh
}

app_rm() {
  validate_dir "$1"
  assert_ne "$2" "Missing $1 name"
  rm -v "$SHELL_RES/$1.d/$2.sh"
}

app_new() {
  validate_dir "$1"
  assert_ne "$2" "Missing $1 name"
  $EDITOR "$SHELL_RES/$1.d/$2.sh"
}

if [ -z "$1" ]; then
  echo "Error: missing argument"
  exit 0
fi

case "$1" in
  '-h' | '--help' | 'help' )
    app_help
    exit 0
    ;;
  'ls' )
    shift
    app_ls $@
    ;;
  'e' | 'edit')
    shift
    app_new $@
    ;;
  'rm')
    shift
    app_rm $@
    ;;
  'g' | 'gen')
    shift
    app_gen_autoload
    ;;
  * )
    echo "Error: invalid command '$1'"
    exit 1
    ;;
esac
