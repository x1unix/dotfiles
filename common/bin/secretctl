#!/usr/bin/env sh
set -e
BIN_NAME="$(basename $0)"

export GPG_TTY=$(tty)
EDITOR="${EDITOR:-vim}"

die() {
  printf "Error: %s\n" "$1" >&2
  exit 1
}

command_exists() {
  if ! command -v "$1" >/dev/null 2>&1; then
    return 1
  fi

  return 0
}

secretctl_secret_create() {
  die 'not implemented'
}

secretctl_check_env() {
  for tool in sops jq gpg "$EDITOR"; do
    if ! command_exists "$tool"; then
      die "$tool is not installed"
    fi
  done
}

secretctl_secret_edit_cleanup() {
  if [ -n "$1" ] && [ -f "$1" ]; then
    rm -f "$1"
  fi
}

secretctl_secret_edit() {
  secret_file="$1"
  if [ -z "$secret_file" ]; then
    cat <<EOF
$BIN_NAME edit - Update contents of a secret file encoded using SOPS+GPG

Usage: $0 [file]
EOF
    exit 0
  fi

  secretctl_check_env
  if [ ! -f "$secret_file" ]; then
    die "file doesn't exist - $secret_file"
  fi

  if ! keyid="$(jq -r -e '.sops.pgp[0].fp' "$secret_file")"; then
    die "secret is not a GPG SOPS secret file"
  fi

  tmpfile="$(mktemp)"
  trap "secretctl_secret_edit_cleanup '$tmpfile'" EXIT ERR

  echo ":: Decrypting secret '$secret_file' with sops"
  if ! sops --decrypt "$secret_file" >"$tmpfile"; then
    die "cannot decrypt a file"
  fi

  old_hash="$(md5sum "$tmpfile" | awk '{print $1}')"
  "$EDITOR" "$tmpfile"
  new_hash="$(md5sum "$tmpfile" | awk '{print $1}')"
  if [ "$new_hash" = "$old_hash" ]; then
    echo "File not changed, exit."
    exit 1
  fi

  echo ":: Encrypting file using GPG key '$keyid'"
  if ! sops --encrypt --pgp "$keyid" "$tmpfile" >"$secret_file"; then
    die "failed to update secret file"
  fi

  echo "Success!"
}

secretctl_usage() {
  cat <<EOF
$BIN_NAME - SOPS GPG secret file management tool.

Usage: $0 <command> args...

Subcommands:
  create  Create a secret file
  edit    Edit a secret file
EOF
  exit 0
}

arg="$1"
if [ -z "$arg" ]; then
  secretctl_usage
fi

shift

case "$arg" in
'create' | 'new' | 'c')
  secretctl_secret_create $*
  ;;
'edit' | 'e')
  secretctl_secret_edit $*
  ;;
'help' | '-h' | '--help')
  secretctl_usage
  ;;
*)
  die "Unknown subcommand '$arg'"
  ;;
esac
